# README

## Overview

The code in this replication package is the code used for the analysis in Aryal, Murry, and Williams (2022), Review of Economic Studies). The data is organized using STATA and the model is estimated in Matlab. This package can generate all of the figures and tables in the manuscript. The entire procedure may take on the order of weeks on a high powered computing cluster, however we provide guidance on running the code at a smaller scale.

---
## Data Availability and Provenance Statements

- [ ] This paper does not involve analysis of external data (i.e., no data are used or the only data are generated by the authors via simulation in their code).


### Statement about Rights

- [x] I certify that the author(s) of the manuscript have legitimate access to and permission to use the data used in this manuscript. 
- [ ] I certify that the author(s) of the manuscript have documented permission to redistribute/publish the data contained within this replication package. Appropriate permission are documented in the [LICENSE.txt](LICENSE.txt) file.


### Summary of Availability

- [ ] All data **are** publicly available.
- [x] Some data **cannot be made** publicly available.
- [ ] **No data can be made** publicly available.

### Details on each Data Source

No source files are made available with the replication package, however, below is a list of the four secondary data sources with an example source file that us used in the programs.

| Data.Name  | Data.Files | Location | Provided | Citation |
| -- | -- | -- | -- | -- | 
| “Survey of International Air Travelers” | e.g. res4y09.dta | data/raw/siat/ | FALSE | U.S. Department of Commerce SIAT (2012) |
| “OAG” | capacitydata_OAG.dta | data/raw/oag/ | FALSE | OAG (2012) |
| “DB1B International” | DB1B.dta | data/raw/db1b/ | FALSE | U.S. Department of Transportation, DB1B (2012) |
| "T-100 International" | e.g. t100_seg_2009.dta | data/raw/t100/ | TRUE | U.S. Department of Transportation, T100 (2012) |

where the `Data.Name` column is then expanded in the subsequent paragraphs, and, for example,`SIAT (2012)` is resolved in the References section of the README.


`Survey of International Air Travelers (SIAT)` is a survey administered by the U.S. Department of Commerce (DOC). The DOC digitizes the survey results. Data is subject to a redistribution restriction, but can be purchased from the DOC at the following website: `https://www.trade.gov/survey-international-air-travelers-siat`. We use the full survey (inbound and outbound) for years 2009, 2010, and 2011. The data can be purchased by filling out a [Custom Order Form](https://www.trade.gov/sites/default/files/2020-08/NTTO%20Order%20Form.pdf) with the above description. We have included shell datasets so that interested researchers understand exactly which fields were included with our source data. The DOC charges a processing fee to provide these data.


`OAG` refers to data form OAG: Flight Database and Statistics provided by Aviation Analytics. We use their [Flight Seats Data](https://www.oag.com/flight-data-seats) to measure the equipment and capacity of each flight in the SIAT sample. We purchased a custom pull of these data to save on costs. Our contact at OAG is `russ.terregino@oag.com`. See the file `data/raw/oag/capacitydata_OAG_shell.dta` for field names.


`DB1B International` refers to the international version of the U.S. Bureau of Transportation Statistics Passenger and Origin-Destination Survey (or so-called "DB1B" data). Information about the DB1B can be found on the [BTS website](https://www.transtats.bts.gov/Tables.asp). We included a shell dataset with the variables we used in our analysis, `DB1B_shell.dta`. However, the international flights are not available in the dataset available to the public. Access to the international routes requires filling out a request form at [this website](https://www.bts.gov/topics/airlines-and-airports/restricted-data). 


`T100 International` is a survey administered by the Bureau of Transportation statistics that reports total passengers. Historical international versions of these data are available on the [BTS website](https://www.bts.dot.gov/browse-statistical-products-and-data/bts-publications/%E2%80%A2-data-bank-28is-t-100-and-t-100f), including access to the international data, which is not restricted.


---
## Computational requirements

### Software Requirements

- Stata (code was last run with version 17)
- Matlab 2021b
- Midaco
  - Midaco is a proprietary Matlab package for Mixed Integer Non-linear Programming. The software is available from `http://www.midaco-solver.com/index.php/download/matlab`. There is a free downloadable trial version available that can handle four policy variables, which can be used to solve our baseline specification. However, additional counterfactual computations in the paper require more than four policy variables, so the paid version is necessary. The package is available in many other languages. 
  
Portions of the code will need to be deployed on a distributed computing cluster if the code is run at scale. We provide guidance on running the code at smaller scale, which would likely not require the use of high-powered computing resources.


### Controlled Randomness

- [x] Random seed is set at line 3 of program `analysis/3_estimation/f1_samplegrid.m`. 
  - This draws the 10,000 parameters that we use as our parameter grid for estimation.
  - We provide the grid that we use in estimation in `aux_output/grid_AMW.mat`


### Memory and Runtime Requirements

Data prep done in `STATA` and tables/graphs creation for data description can be run locally and should take less than an hour. The codes should be run on a machine with at least 12gb of RAM.  

The solving of the structural model in `Matlab` requires more advanced computing resources. See below for a description of the process and requirements. 

#### Summary

Approximate time needed to reproduce the analyses on a standard (CURRENT YEAR) desktop machine:

- [ ] <10 minutes
- [ ] 10-60 minutes
- [ ] 1-2 hours
- [ ] 2-8 hours
- [ ] 8-24 hours
- [ ] 1-3 days
- [ ] 3-14 days
- [ ] > 14 days
- [x] Not feasible to run on a desktop machine, as described below.


#### Details

We solved for the value functions by employing 2000-3000 compute cores at a time, each for on the order of 3-4 days. We need a total of 10,000 cores, so the entire procedure of solving for the value function takes on the order of two weeks. Similar resources are needed to solve the value functions for the counterfactuals. We also used parallelization for estimating the parameters. We have provided `slurm` scripts as examples.  Total core-hours consumed for the entire project is on the order of 600,000 core hours. 


### License for Code

The code is licensed under a MIT license. See [LICENSE.txt](LICENSE.txt) for details.


## Instructions to Replicators

Put the downloaded data in the associated raw data directories, analogous to where the "shell" data currently resides.

### Prep data for analysis. 
- Run `analysis/1_cleaning/run_cleaning.do`

### Tables and Figures in Section 2
- Run `/analysis/2_section2_graphs_and_tables/f5_tables.do`
- Run `/analysis/2_section2_graphs_and_tables/f6_figures.m`

### Solve the model for value functions.
- run `analysis/3_estimation/1_solve/f1_samplegrid.m` to create parameter grid.
- run `analysis/3_estimation/1_solve/f2_subshell_main.m` for inputs `j=1:10000` to solve the model for each of the $10,000$ grid points. We provide a slurm script that batch submits jobs.

### Forward simulate model
- Run `analysis/3_estimation/2_model_forward_simulation/create_capacity_weights.m`.
- Run `analysis/3_estimation/2_model_forward_simulation/modsim1.m1` for inputs `capIdx=1:20`. 
- We have included a slurm script, `mja_modsim.sl` that runs `modsim1` on a HPC cluster.

### Construct moments for estimation
- Run `analysis/3_estimation/3_moments/make_moments.m`.
  - This may need to be run on a HPC cluster. We have incuded `analysis/3_estimation/3_moments/moments_model/mja_calc_regmom.sl` as a guide.
- For bootstrap, run `analysis/3_estimation/3_moments/moments_data/bootstrap/do_smooth_bs.m`. This can be run on a local machine.

### Estimate parameters
- Run `analysis/3_estimation/4_estimate/run_estimation.m`
- For bootstrap, run `analysis/3_estimation/4_estimate/main_bs.m` for `capId=1:20`.

### Produce Section 5 results plots and tables
- Run `analysis/4_section5_graphs_and_tables/run_tabs_figs.m`


### Counterfactual solve and results table.
- Run `analysis/5_counterfactuals/run_counterfactuals.m`.
  - The tables for the counterfactuals are generated in `analysis/5_counterfactuals/counterfactualTable.m`.


### Notes for running a scaled down version of solving the model. 
Before running `f2_subshell_main(j)` to solve for the value functions, adjust `/analysis/3_estimation/1_solve/feed_parmtrs.m` starting at line $18$. 
- `nt` controls the number of time periods to solve the model. 
- `nsim` controls how many simulation draws to take. 
Also adjust the interpolation grid in `/analysis/3_estimation/1_solve/state_loop_new.m`.
- comment out lines $30-31$ and change and comment in lines $36-37$.
Alternatively, we also include all of our solved value functions in `aux_output/model_solve_results/baseline/`. There are $10,000$ `.mat` files. This way, a researcher would not have to solve the value functions themselves, which is a large computational endeavor. We also include `aux_output/estimation_results/tpdf_min_AMW.mat` which is the estimation results -- containing the weight for each of the $10,000$ candidate parameter vectors.  

---
## List of Table/Figures and associated programs

The provided code reproduces:

| Figure/Table #    | Program                                  |     Note           |    
|-------------------|------------------------------------------|----------------------|
| Tables 1-4        | `/analysis/2_description/f5_tables.do`   |            |
| Figures 1, 2, 6b  | `/analysis/2_description/f6_1_figures.m` | f6_figures.m runs all figures in Sec. 2 |
| Figure 5          | `/analysis/2_description/f6_2_figures.m` |  f6_figures.m runs all figures in Sec. 2 |
| Figures 3, 4      | `/analysis/2_description/f6_3_figures.m` |   f6_figures.m runs all figures in Sec. 2 |
| Figure 6a         | `/analysis/2_description/f6_4_figures.m` |   f6_figures.m runs all figures in Sec. 2 |
| Figure 7, 8       | none  | latex tikz picture |
| Table 5           | `analysis/4_section5_graphs_and_tables/tables_figures.m` | line 118 | 
| Figure 9          | `analysis/4_section5_graphs_and_tables/tables_figures.m`  | line 171 |
| Figure 10         | `analysis/4_section5_graphs_and_tables/tables_figures.m`  | line 337 |
| Figure 11         | `analysis/4_section5_graphs_and_tables/tables_figures.m`  | line 435 |
| Figure 12         | `analysis/4_section5_graphs_and_tables/tables_figures.m`  | line 501 |
| Figure 13         | `analysis/4_section5_graphs_and_tables/tables_figures.m`  | line 522 |
| Figure 14         | `analysis/4_section5_graphs_and_tables/tables_figures.m`  | line 621 |
| Figure 15         | none  | latex tikz picture |
| Table 6           | `analysis/5_counterfactuals/counterfactualTable.m` |   |  |
| Table 7           | `analysis/3_estimation/2_model_forward_simulation/modsim3.m` | line 269, matrix saved in .mat file and calculated manually  |
| Table A.1.1 (top left/right) | `analysis/1_cleaning/f2_process_DOC.do` | Line 294 |
| Table A.1.1 (bottom left/right) | `analysis/1_cleaning/f4_estimation.do` | Line 76 |
| Tables A.2.1 \& A.2.2     | `analysis/4_section5_graphs_and_tables/tables_figures.m` | Line 126 |
| Figure A.3.1/2/3    |`analysis/4_section5_graphs_and_tables/model_fit.m` | |
| Figure A.4.4       | `analysis/4_section5_graphs_and_tables/DP_description` | |



---

## References

Official Aviation Guide of the Airways. 2012. “Flight Database and Statistics: Flight Seats Data (OAG).”

U.S. Department of Commerce, International Trade Administration. 2012. “Survey of Inter- national Air Travelers (SIAT).”

U.S. Department of Transportation, Bureau of Transportation and Statistics. 2012. “The Airline Origin and Destination Survey (DB1B).”

U.S. Department of Transportation, Bureau of Transportation and Statistics. 2012. "Airline Passenger and Freight Traffic (T100).”

Aryal, Gaurab, Charles Murry, and Jonathan W. Williams. "Price discrimination in international airline markets." (2022)

---



