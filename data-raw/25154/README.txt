This folder contains all of the code used to produce the tables and figures in the paper "Price
Discrimination and Public Policy in the U.S. College Market" by Ian Fillmore. All Stata code was run using
Stata 14.




**************************************************************************************************************

DATA AVAILABILITY STATEMENT - NATIONAL POSTSECONDARY STUDENT AID STUDY (NPSAS)
NPSAS is a restricted-use data that was obtained from the National Center for Education Statistics. The 
code here will not run unless this resricted-use data is provided. Users may obtain the data by applying for a 
restricted-use data license through the National Center for Education Statistics (NCES) 
(see https://nces.ed.gov/pubsearch/licenses.asp). This README still lists these restricted-use data files in 
the description, even though they aren't present in the replication file. This way, a user who obtains the 
data through NCES can see where to insert the restricted-use files into the file structure and run the 
replication code.

DATA AVAILABILITY STATEMENT - BEGINNING POSTSECONDARY STUDENTS (BPS)
BPS is a restricted-use data that was obtained from the National Center for Education Statistics. The 
code here will not run unless this resricted-use data is provided. Users may obtain the data by applying for a 
restricted-use data license through the National Center for Education Statistics (NCES) 
(see https://nces.ed.gov/pubsearch/licenses.asp). This README still lists these restricted-use data files in 
the description, even though they aren't present in the replication file. This way, a user who obtains the 
data through NCES can see where to insert the restricted-use files into the file structure and run the 
replication code.

DATA AVAILABILITY STATEMENT - DIGEST OF EDUCATION STATISTICS
I used data from two tables of the Digest of Education Statistics for some ancillary analysis---Table 103 from 
the 2004 Digest and Table 180 from the 2005 Digest. The tables can be downloaded from 
https://nces.ed.gov/programs/digest/ and are included in this archive.

**************************************************************************************************************




DATA FILE					SOURCE		NOTE					PROVIDED
----------------------------------------------------------------------------------------------------------------------
DATA/BPS2008.dta/BPS2009.dta			BPS		Raw BPS data (restricted)			No
DATA/DigestEdStat/stateCohorts.dta		Digest		Data from Digest tables			Yes
DATA/NPSAS2008/NPSAS2008.dta			NPSAS		Raw NPSAS data (restricted)		No
DATA/NPSAS2008/n08wth_revised.dta			NPSAS		Updated weights (restricted)		No
ESTIMATION/DTA files/NPSAS2008_auctionData_R.dta	Derived		NPSAS data prepped for structural est.	No
ESTIMATION/DTA files/BPS2004_auctionData_R.dta	Derived		BPS data prepped for structural est.	No




SOFTWARE REQUIREMENTS
This archive contains code for Stata 14 and R(3.6.1)[64-bit]. The user will need to install the following packages

Software		Package
---------------------------------------------
Stata		gologit2 (available via SSC)
Stata		estout (available via SSC)
R		quantreg
R		MASS
R		minpack.lm
R		rootSolve
R		rngWELL
R		randtoolbox
R		mvtnorm
R		ordinal
R		splines2
R		mgcv
R		glmnet
R		doParallel




RUNTIME
The structural estimation takes about an hour on a desktop with a 2.40 GHz processor and 32 Gb of RAM. The bootstraps
have been parallelized within R to reduce runtime, but the actual speed up will depend on the number of cores available.




DATA/
	This folder contains all of the data used in the project. It also contains the .TAG files and SPSS files 
	that were used to extract the restricted-use data using the electronic codebook and convert it into a 
	Stata.dta file.

	BPS2009/
		This folder contains data from 2004-2009 Beginning Postsecondary Students. It consists of a nationally
		representative cross-section of freshmen during the 2003-2004 school year.
	
		BPS2009.TAG
			This is a tag file for use with the electronic codebook from NCES. It will automatically select 
			the variables included in BPS2009.dta.
		
		BPS2009.sps
			This is the SPSS code that was generated by the electronic codebook from NCES. It reads in and 
			formats the raw data in SPSS. After running the code, the user can then save the data in Stata (.
			dta) format. In order to rerun this code, the user will need to open it and adjust the file paths 
			to correspond to the location of the raw data.
		
		BPS2009.dta *RESTRICTED*
			This is the dataset used in the paper.
	
	
	DigestEdStat/
		Data from the Digest of Education Statistics. It contains the number of graduating high school 
		seniors and the number of enrolled college Freshmen in each state in 2003.
	
	
	NPSAS2008/
		This folder contains data from 2007-2008 National Postsecondary Student Aid Study. It consists of a 
		nationally representative cross-section of postsecondary students during the 2007-2008 school year.

		npsas2008.TAG
			This is a tag file for use with the electronic codebook from NCES. It will automatically select 
			the variables included in NPSAS2008.dta.
		
		NPSAS2008.SPS
			This is the SPSS code that was generated by the electronic codebook from NCES. It reads in and 
			formats the raw data in SPSS.  Then it saves the data in Stata (.dta) format. In order to rerun 
			this code, the user will need to open it and adjust the file paths to correspond to the location 
			of the raw data.
		
		NPSAS2008_updatewts.do
			Stata do-file that replaces the weights in NPSAS2008.dta with the revised weights in 
			n08wth_revised.dta.
		
		NPSAS2008.dta *RESTRICTED*
			This is the dataset used in the paper.
		
		n08wth_revised.dta *RESTRICTED*
			Revised sample weights provided by NCES. These revised weights are provided with the data in a 
			separate file in CSV format. This DTA file is created by NPSAS2008_updatewts.do.
			
		
		
	
ESTIMATION/
	This folder contains all of the estimation commands and estimation results used in the paper. This 
	includes Stata code as well as R code. To replicate the analysis in the paper, files should be run in the 
	following order:

	1. Do files/NPSAS2008_analysis.do
	2. Do files/BPS2009_analysis.do
	3. Do files/NPSAS2008_auctionPrep.do
	4. R Code/NPSAS2008_script.R
	5. Do files/NPSAS2008_auctionAnalysis.do
	
	DO files/
		This folder contains all of the Stata do-files used to produce tables and figures in the paper. The 
		user will need to install the gologit2 Stata package through SSC.
	
		NPSAS2008_analysis.do [log file generated as *.log]
			This do-file runs the bulk of the reduced form analysis in the paper. Results are written to 
			"../RESULTS/".
		
		
		BPS2009_analysis.do [log file generated as *.log]
			This do-file creates some datasets (distListed.dta, distApps1.dta, distApps2.dta, distApps3.dta) 
			in "../DTA files/" that are used in the structural estimation. It also creates some tables and 
			figures that are used in the paper.
		
		
		NPSAS2008_auctionPrep.do [log file generated as *.log]
			This creates the dataset, "../DTA files/NPSAS2008_auctionData_R.dta", that is used for the 
			structural estimation in R.
		
		
		NPSAS2008_auctionAnalysis.do [log file generated as *.log]
			This produces several of the tables and figures in the paper for the structural estimation. It 
			uses output from the structural estimation in R. Results are written to "../RESULTS/".
		
		
		BPS2009_variablecreate.do
			This do-file is run by BPS2009_analysis.do to perform the sample selection and create all 
			necessary variables.
		
		
		NPSAS2008_variablecreate.do
			This do-file is run by NPSAS2008_analysis.do and NPSAS2008_auctionPrep.do to perform the sample 
			selection and create all necessary variables.

			
	DTA files/
		Contains Stata datasets that have been prepped for the structural estimation in R. 

		NPSAS2008_auctionData_R.dta *RESTRICTED*

		BPS2004_auctionData_R.dta *RESTRICTED*
	
	
	R Code/
		This folder contains all of the R code used to perform the structural estimation. The do-file 
		../DO files/NPSAS2008_auctionPrep.do must be run first. The only file in this folder that needs to be
		run is NPSAS2008_script.R. However, the user will need to modify the file path and install the 
		following packages: quantreg, MASS, minpack.lm, rootSolve, rngWELL, randtoolbox, mvtnorm, ordinal, 
		splines2, mgcv, glmnet, and doParallel.
	
		-------------- MAIN SCRIPT -------------
		
		NPSAS2008_script.R
			This script runs the entire estimation including the bootstrapping. However, each iteration of the 
			bootstrap takes 30-60 minutes (on a desktop computer), so the user may want to only run the 
			portion of the code that produces the point estimates.
		
		--------- SUPPORTING FUNCTIONS ---------
		
		NPSAS2008_auction.R
			This file contains a function that runs the entire estimation once. It is called by 
			NPSAS2008_script.R.
		
		appsFit.R
			This file contains a function that fits an ordered probit regression using data and obtains 
			predicted probabilities for observations in newdata. It returns a matrix with N rows and appsMax 
			columns, where N is the number of observations in newdata and appsmax is the maximum number of 
			applications. It is called by NPSAS2008_auction.R.
		
		bidFunLambda.R
			This file contains functions for calculating counterfactual bid functions with a calibrated amount 
			of uncertainty in the student's valuation of the outside option. It is called by 
			NPSAS2008_auction.R. (Note: This functionality is not used in the paper.)
		
		calcResults.R
			This file contains a function for calculating the desired statistics from the estimation results. 
			It is called by NPSAS2008_script.R.
		
		cntrfctlBidFun.R
			This file contains functions for calculating the counterfactual bid function. It is called by 
			NPSAS2008_auction.R.
		
		condExpectation.R
			This file contains a function that calculates the conditional expectation E[xi|e>b] given as 
			inputs E[xi|e=b] and the marginal PDF and CDF of e. It is called by NPSAS2008_auction.R.
		
		copula.R
			This file contains functions for calculating the Frank copula and its derivatives. It is called by 
			NPSAS2008_auction.R.
		
		parentDistn.R
			This file contains functions for calculating the parent PDF and CDF of a random variable, given 
			the distribution of the first order statistic of that random variable. It is called by 
			NPSAS2008_auction.R.
		
		qde.R
			This file contains functions used to estimate a conditional cdf and pdf. It is called by 
			NPSAS2008_auction.R.
		
		tailFit.R
			This file contains functions for approximating the tail of a (bounded) distribution. It is called 
			by NPSAS2008_auction.R.
		
		truncDistn.R
			This file contains a function that calculates the truncated distribution of a given distribution. 
			It is called by NPSAS2008_auction.R.
	
	
	RESULTS/
		Contains the estimation tables and figures produced by the Stata do-files as well as the R code.
	
		Bootstraps/
			Contains point estimates from the structural estimation as well as each of the bootstrap estimates.




ADDITIONAL INSTRUCTIONS
- The user will need to alter the file path at the top of each Stata do-file and R script. 
- I have found that, for some reason, the parallelization will occasionally fail for some of the bootstraps. This appears 
  to be a bug in the parallelizing process. Simply rerunning the few missing bootstraps will usually fix the problem 
  (NPSAS2008_script.R is already set up to do this).
- All of the tables, other than regression tables, are stored in ESTIMATION/RESULTS/Tables.xlsx. In addition to the sheets 
  containing the formatted tables, there are a number of hidden sheets that Stata automatically writes to. 
- For Tables containing structural results, R returns these results to the file auctionResults_boot.log. I then manually 
  copied them over to the corresponding hidden sheets in Tables.xlsx.  If the user wants to generate formatted tables with 
  different results, he or she will have to repeat this process.
- Stata saves regression tables as Regression_Table_foo.csv. I then copied coefficients and standard errors over to 
  the formatted tables in Regression_Tables.xlsx.




REFERENCES

National Center for Education Statistics, U.S. Department of Education. Beginning Postsecondary Students, 2004.

National Center for Education Statistics, U.S. Department of Education. Digest of Education Statistics, 2004 & 2005.

National Center for Education Statistics, U.S. Department of Education. National Postsecondary Student Aid Study, 2008.
